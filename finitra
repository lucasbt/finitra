#!/usr/bin/env bash
# =============================================================================
# finitra -- Fedora Workstation Bootstrap for Developers
# =============================================================================

set -euo pipefail

# =============================================================================
# Detect real (non-root) user BEFORE using $HOME
# =============================================================================
_detect_user() {
  if [[ -n "${SETUP_USER:-}" && "${SETUP_USER}" != "root" ]]; then
    SETUP_HOME="${SETUP_HOME:-$(eval echo "~${SETUP_USER}")}"
    return
  fi

  if [[ $EUID -eq 0 && -n "${SUDO_USER:-}" && "${SUDO_USER}" != "root" ]]; then
    SETUP_USER="$SUDO_USER"
    SETUP_HOME=$(eval echo "~${SUDO_USER}")
    return
  fi

  if [[ $EUID -ne 0 ]]; then
    SETUP_USER="$USER"
    SETUP_HOME="$HOME"
    return
  fi

  local logname_user
  logname_user=$(logname 2>/dev/null || true)
  if [[ -n "$logname_user" && "$logname_user" != "root" ]]; then
    SETUP_USER="$logname_user"
    SETUP_HOME=$(eval echo "~${logname_user}")
    return
  fi

  echo "ERROR: Could not determine the real user." >&2
  exit 1
}

_detect_user

# =============================================================================
# Define paths (NEVER use $HOME below this point)
# =============================================================================

BIN_DIR="${SETUP_HOME}/.local/bin"
BIN_PATH="${BIN_DIR}/finitra"
CONFIG_DIR="${SETUP_HOME}/.config/finitra"
CONFIG_FILE="${CONFIG_DIR}/finitra.config"
SCRIPT_DIR="${SETUP_HOME}/.local/share/finitra"
SCRIPT_VERSION="$(cat "${SCRIPT_DIR}/version" 2>/dev/null | tr -d '[:space:]' || echo "unknown")"

export SETUP_USER SETUP_HOME

# =============================================================================
# Load config
# =============================================================================

source "${SCRIPT_DIR}/utils.sh"
source "${SCRIPT_DIR}/finitra-default.config"

USER_CONFIG="${SETUP_HOME}/.config/finitra/finitra.config"
[[ -f "$USER_CONFIG" ]] && source "$USER_CONFIG"

# =============================================================================
# Initialize log
# =============================================================================

LOG_FILE="${CACHE_DIR:-${SETUP_HOME}/.cache/finitra}/finitra.log"
mkdir -p "$(dirname "$LOG_FILE")" 2>/dev/null || true
: > "$LOG_FILE"

export LOG_FILE

# =============================================================================
# Module system
# =============================================================================

declare -A MODULE_FILES
declare -A MODULE_NAMES

_discover_modules() {
  local modules_dir="${SCRIPT_DIR}/modules"
  while IFS= read -r -d '' file; do
    local base num name
    base=$(basename "$file" .sh)
    num="${base%%-*}"
    name="${base#*-}"
    MODULE_FILES["$num"]="$file"
    MODULE_NAMES["$num"]="${num} -- ${name}"
  done < <(find "$modules_dir" -maxdepth 1 -name "[0-9]*.sh" -print0 | sort -z)
}

_resolve_module_id() {
  local input="$1"

  if [[ -n "${MODULE_FILES[$input]:-}" ]]; then
    echo "$input"
    return 0
  fi

  for key in "${!MODULE_FILES[@]}"; do
    local base name_part
    base=$(basename "${MODULE_FILES[$key]}" .sh)
    name_part="${base#*-}"
    if [[ "$name_part" == "$input" || "$base" == "$input" ]]; then
      echo "$key"
      return 0
    fi
  done

  return 1
}

_run_module() {
  local input="$1"
  local resolved

  if ! resolved=$(_resolve_module_id "$input"); then
    log_error "Module not found: '$input'"
    return 1
  fi

  local file="${MODULE_FILES[$resolved]}"
  log_info "Loading module: $(basename "$file")"
  source "$file"

  local funcname
  funcname="module_$(basename "$file" .sh | tr '-' '_')"

  if declare -f "$funcname" >/dev/null; then
    "$funcname"
  else
    log_error "Function '$funcname' not found in $file"
    return 1
  fi
}

_run_all_modules() {
  local sorted_keys
  mapfile -t sorted_keys < <(printf '%s\n' "${!MODULE_FILES[@]}" | sort)

  log_section "Running ALL modules in sequence"
  for num in "${sorted_keys[@]}"; do
    _run_module "$num"
  done
  log_success "All modules completed successfully!"
}

# =============================================================================
# Self-update
# =============================================================================

_cmd_update() {
  log_section "finitra self-update"

  local install_dir="${SETUP_HOME}/.local/share/finitra"

  if [[ ! -d "${install_dir}/.git" ]]; then
    log_error "Not a git repository: $install_dir"
    exit 1
  fi

  git -C "$install_dir" pull --ff-only

  chmod +x "${install_dir}/finitra"
  find "${install_dir}/modules" -name "*.sh" -exec chmod +x {} \;

  local new_version
  new_version=$(cat "${install_dir}/version" 2>/dev/null | tr -d '[:space:]' || echo "unknown")

  log_success "Updated to version ${new_version}"
}

# =============================================================================
# Banner + preflight
# =============================================================================

_print_banner() {
  clear
  echo ""
  echo -e "${CLR_BOLD}${CLR_CYAN}  ███████╗██╗███╗   ██╗██╗████████╗██████╗  █████╗ ${CLR_RESET}"
  echo -e "${CLR_BOLD}${CLR_CYAN}  ██╔════╝██║████╗  ██║██║╚══██╔══╝██╔══██╗██╔══██╗${CLR_RESET}"
  echo -e "${CLR_BOLD}${CLR_CYAN}  █████╗  ██║██╔██╗ ██║██║   ██║   ██████╔╝███████║${CLR_RESET}"
  echo -e "${CLR_BOLD}${CLR_CYAN}  ██╔══╝  ██║██║╚██╗██║██║   ██║   ██╔══██╗██╔══██║${CLR_RESET}"
  echo -e "${CLR_BOLD}${CLR_CYAN}  ██║     ██║██║ ╚████║██║   ██║   ██║  ██║██║  ██║${CLR_RESET}"
  echo -e "${CLR_BOLD}${CLR_CYAN}  ╚═╝     ╚═╝╚═╝  ╚═══╝╚═╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝${CLR_RESET}"
  echo ""
  echo -e "  ${CLR_BOLD}Fedora Workstation Bootstrap for Developers${CLR_RESET}"
  echo ""
}

_preflight_check() {
  log_info "Target user : ${SETUP_USER} (home: ${SETUP_HOME})"
  log_info "Log file    : ${LOG_FILE}"
}

# =============================================================================
# Entry point
# =============================================================================

main() {

  case "${1:-}" in
    update)
      _cmd_update
      exit 0
      ;;
    list|--list)
      _discover_modules
      for num in $(printf '%s\n' "${!MODULE_FILES[@]}" | sort); do
        printf "%-6s %s\n" "$num" "${MODULE_NAMES[$num]}"
      done
      exit 0
      ;;
    "")
      ;;
    install|-i|--all|-a)
      ;;
    *)
      echo "Unknown command: $1"
      exit 1
      ;;
  esac

  _print_banner
  _preflight_check
  _discover_modules
  _run_all_modules

  echo ""
  log_success "finitra done. Log saved to: ${LOG_FILE}"
}

main "$@"